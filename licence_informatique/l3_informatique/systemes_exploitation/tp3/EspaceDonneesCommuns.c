#include <sys/types.h> // pour pid_t
#include <unistd.h> // pour fork()
#include <stdio.h> // pour printf
#include <string.h> // pour string
#include <unistd.h> 
#include <stdlib.h> // exit
#include <sys/wait.h> // pour wait()
#include <sys/ipc.h> // pour ipc
#include <sys/shm.h> // pour shm
#include <errno.h> // pour errno
#define MAX 1000000000

int main() {
    char* adr1;
    char* adr2;
    int status, cle = 5;
    pid_t fils_pid;
    // boucle affichant le nombre de fils demandée
        switch (fils_pid=fork()) {
        case -1: // échec du fork 
            fprintf(stderr, "échec du fork \n");
            perror("fork");
            exit(-1);
        case 0: // code du fils
            if ((status = shmget(cle,sizeof(int),0))==-1){
                printf("shm2.shmget: %s\n", strerror(errno));
                exit(1);
            }
            printf("status = %d\n", status);
            if(( adr2 =(char*) shmat(status, NULL, 0)) == (char*)-1){
                printf("shm2.shmat: %s\n", strerror(errno));
                exit(1);
            }
            printf("adr2 = %p, *adr2 = %s \n", adr2, adr2);
            if(shmdt(adr2) == -1) {
                printf("shm2.shmdt: %s\n", strerror(errno));
                exit(1);
            }
            if(shmctl(status, IPC_RMID, NULL) == -1) {
                printf("shm2.shmctl: %s\n", strerror(errno));
                exit(1);
            }
            exit(0);
        default: // code du père 
            if ((status = shmget(cle,sizeof(int),IPC_CREAT|0666))==-1){
                printf("shm1.shmget: %s\n", strerror(errno));
                exit(1);
            }
            if(( adr1 =(char*) shmat(status, NULL, 0)) == (char*)-1){
                printf("shm1.shmat: %s\n", strerror(errno));
                exit(1);
            }
            strcpy(adr1,"ekip");
            printf("adr1 = %p, *adr1 = %s \n", adr1, adr1);
            sleep(2);
            if(shmdt(adr1) == -1) {
                printf("shm1.shmdt: %s\n", strerror(errno));
                exit(1);
            }
        }
    printf("status = %d\n", status);
    sleep(2); //laisse le programme tourner pour afficher les zombies
    return 0;
}